window.BMLoader={version:"v2.2.3",scripts:{},parseScript(e,t){var a={md:false,multi:false},r="==Bookmarklet==",s="==/Bookmarklet==",i={cmt:/^(\s*\/\/\s*)/,multi:{start:/^(\s*\/\*\s*@bookmarklet\s*)/i,end:/^\s*\*\//},single:{start:/\s*@bookmarklet\s*/,match:/\s*@[^@]*/g}},o={name:"",version:"",description:"",repository:"",author:[],email:"",url:"",license:"",script:[],style:[],var:[],async:false},l={},n=[],c=[],d=false,p=e=>{var t=e.trim().match(/@([^\s]+)(?:\s+(.*))?$/);if(t){var a=t[1],r=t[2];if(a!==undefined){if(Array.isArray(o[a])){l[a]=l[a]||[];l[a].push(r)}else if(typeof o[a]=="boolean"){try{l[a]=JSON.parse(r)}catch(e){l[a]=true}}else{l[a]=r}}else{console.warn(`ignoring invalid metadata option: \`${a}\``)}}};e.match(/[^\r\n]+/g).forEach((e,t,o)=>{if(i.cmt.test(e)){var l=e.replace(i.cmt,"").trim(),m=l.toLowerCase().replace(/\s+/g,"");if(!a.md){if(m==r.toLowerCase()){a.md=true;d=true}else if(i.single.start.test(l)){l.replace(i.single.start,"");for(var h=i.single.match.exec(l);h;h=i.single.match.exec(l)){p(h[0])}}}else{if(m==s.toLowerCase()){a.md=false}else{p(l)}}}else if(i.multi.end.test(e)&&a.multi){a.multi=false}else if(a.multi){p(e)}else if(i.multi.start.test(e)){a.multi=true;d=true}else{n.push(e)}if((a.md||a.multi)&&t+1==o.length){c.push(`missing metdata block closing \`${s}\``)}});return{metadata:Object.assign(l,t),code:n.join("\n"),errors:c.length?c:null,bookmarklet:d}},processScript(scripttext,providedmd){return new Promise(async resolve=>{var parsed=this.parseScript(scripttext,providedmd),meta=parsed.metadata,code=parsed.code,waitScript=new Promise(async e=>{if(!meta.script){e()}else{let a=meta.script;for(var t=0;t<a.length;t++){let e=a[t],r=e.split(" "),s;if(r[0]=="dir"){await this.getGithub("coolreader18/bookmarklet-loader/depend-dir-scripts.min.json").then(e=>fetch(e)).then(e=>e.json()).then(t=>{var a=t[r[1].toLowerCase()];e=a.url.replace(/%version/,r[2]||a.latest);s=a.md})}}await this.loadScript(toload,md);if(t==a.length-1){e()}}});if(meta.style){meta.style.forEach(async e=>{var t=e,a=e.split(" "),r=document.createElement("link");r.rel="stylesheet";r.href=t;if(a[0]=="dir"){await this.getGithub("coolreader18/bookmarklet-loader/depend-dir-styles.min.json").then(e=>fetch(e)).then(e=>e.json()).then(e=>{var r=e[a[1].toLowerCase()];t=r.url.replace(/%version/,a[2]||r.latest)})}document.head.append(r)})}["var","async"].forEach(e=>{if(parsed[e]){parsed[e]=parsed.metadata[e];delete parsed[e]}});Object.assign(parsed.metadata,providedmd);await waitScript;var namespace;if(parsed.metadata.name){namespace=this.scripts[meta.name]=this.scripts[meta.name]||parsed}parsed.var=parsed.var||[];parsed.var=parsed.var.reduce((e,t)=>{var a=t.split(" ");e[a[0]]=a[1]||a[0];return e},{});var module={exports:undefined};if(parsed.bookmarklet){namespace.clicks=namespace.clicks+1||0;eval(`(${parsed.metadata.async?"async ":""}function(${Object.values(parsed.var).join()}){${code}})`).apply(namespace,eval(`[${Object.keys(parsed.var).join()}]`))}else{eval(code)}resolve(module.exports)})},loadScript(e,t){return fetch(e).then(e=>{if(e.ok){return e.text()}else{throw new Error("Couldn't load the bookmarklet")}}).then(e=>this.processScript(e,t)).catch(alert)},get loadBookmarklet(){return BMLoader.loadScript},getGithub(e){var t=e.split("/"),a=t.slice(0,2).join("/");return fetch(`https://api.github.com/repos/${a}/releases/latest`).then(e=>{if(e.ok){return e.json().then(e=>`https://cdn.rawgit.com/${a}/${e.tag_name}/${t.slice(2).join("/")}`)}else{throw new Error("Couldn't connect to GitHub")}}).catch(alert)},loadGithub(e){return this.getGithub(e).then(e=>this.loadScript(e))}};