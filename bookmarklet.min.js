BMLoader={scripts:{}},BMLoader.parseFile=function(e){var t=!1,a="==/Bookmarklet==",r=/^(\s*\/\/\s*)/,o={name:"",version:"",description:"",repository:"",author:"",email:"",url:"",license:"",script:[],style:[],init:[]},s={},n=[],i=[],c=!1;return e.match(/[^\r\n]+/g).forEach(function(e,l,p){if(r.test(e)){var d=e.replace(r,"").trim(),m=d.toLowerCase().replace(/\s+/g,"");if(t)if(m==a.toLowerCase())t=!1;else{var u=d.match(/^@([^\s]+)\s+(.*)$/);if(u){var h=u[1],f=u[2];h?Array.isArray(o[h])?(s[h]=s[h]||[],s[h].push(f)):s[h]=f:warn("ignoring invalid metadata option: `"+h+"`")}}else m=="==Bookmarklet==".toLowerCase()&&(t=!0,c=!0)}else n.push(e);t&&l+1==p.length&&i.push("missing metdata block closing `"+a+"`")}),{metadata:s,code:n.join("\n"),errors:i.length?i:null,bookmarklet:c}},BMLoader.loadBookmarklet=function(e){return fetch(e).then(function(e){if(e.ok)return e.text().then(BMLoader.processScript);400==xmlhttp.status&&alert("Couldn't load the bookmarklet")})},BMLoader.processScript=async function(scripttext){var parsed=BMLoader.parseFile(scripttext),meta=parsed.metadata,code=parsed.code,waitScript=new Promise(async function(e){meta.script?meta.script.forEach(async function(t,a,r){await BMLoader.loadBookmarklet(t),a==r.length-1&&e()}):e()});if(meta.style&&meta.style.forEach(function(e){var t=document.createElement("link");t.rel="stylesheet",t.href=e,document.head.append(t)}),await waitScript,parsed.bookmarklet){var namespace=BMLoader.scripts[meta.name]=BMLoader.scripts[meta.name]||parsed;namespace.clicks=namespace.clicks+1||0,eval("(function(){"+code+"})").apply(namespace)}else eval(code)},BMLoader.loadGithub=function(e){var t=e.split("/"),a=t.slice(0,2).join("/"),r=t.slice(2).join("/");return fetch("https://api.github.com/repos/"+a+"/releases/latest").then(e=>{e.ok?e.json().then(e=>{BMLoader.loadBookmarklet("https://cdn.rawgit.com/"+a+"/"+e.tag_name+"/"+r)}):alert("Couldn't connect to GitHub")})};
